name: Release

#on:
#  push:
#    tags:
#      - "v*"

on:
  pull_request:

env:
  SUBQUERY_ORG: fewensa
  SUBQL_ACCESS_TOKEN: ${{ secrets.SUBQUERY_TOKEN }}
  SUBQL_INDEXER_VERSION: v1.0.0
  SUBQL_QUERY_VERSION: v1.0.0

jobs:
  deploy-subql:
    name: Deploy subql
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chain:
          - pangolin
          - pangoro
          - darwinia
          - crab
          - pangolin-parachain
          - crab-parachain
          - kusama
          - rococo
    steps:
      - uses: trstringer/manual-approval@v1
        timeout-minutes: 15
        with:
          secret: ${{ github.TOKEN }}
          approvers: fewensa,HackFisher,JayJay1024,sxlwar
          minimum-approvals: 1
          issue-title: "Deploy subql for production mode about chain ${{ matrix.chain }}?"

      - uses: actions/checkout@v2
      - uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: install deps
        working-directory: subql
        run: yarn install

      - name: build subql
        working-directory: subql
        run: npm run build:${{ matrix.chain }}

      - name: publish subql
        working-directory: subql
        run: npm run publish -- ${{ matrix.chain }}

      - name: deploy subql
        working-directory: subql
        run: |
          npx subql deployment:deploy -d \
            --type primary \
            --indexerVersion=${{ env.SUBQL_INDEXER_VERSION }} \
            --queryVersion=${{ env.SUBQL_QUERY_VERSION }} \
            --org ${{ env.SUBQUERY_ORG }} \
            --projectName ${{ matrix.chain }} \
            --endpoint $(cat project.yaml | yq '.network.endpoint') \
            --ipfsCID $(cat .project-cid)

